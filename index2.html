<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adora | Ù…ØªØ§Ø¨Ø¹Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* ============================================================
           CSS (V20.1: Fixed Logs & Persistence)
           ============================================================ */
        :root { --bg-body: #f4f6f8; --bg-card: #ffffff; --text-main: #2c3e50; --text-sec: #7f8c8d; --border-color: #e0e0e0; --primary: #0097a7; --primary-light: #e0f7fa; --success: #00b894; --danger: #d63031; --warning: #f1c40f; --upgrade: #7e57c2; --request-color: #673AB7; --request-light: #EDE7F6; --maint-card-bg: #f3e5f5; --maint-card-border: #9c27b0; --shadow: 0 4px 15px rgba(0,0,0,0.05); --circle-width: 7px; }
        body.dark-mode { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-sec: #94a3b8; --border-color: #334155; --primary: #38bdf8; --primary-light: rgba(56, 189, 248, 0.1); --request-color: #A78BFA; --request-light: rgba(139, 92, 246, 0.1); --maint-card-bg: #4a148c; --maint-card-border: #ea80fc; --shadow: 0 4px 20px rgba(0,0,0,0.4); }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px 15px 80px 15px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        .container { max-width: 500px; margin: 0 auto; }
        
        .header-glass { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 12px 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header-right h1 { font-size: 1.1rem; margin: 0; color: var(--primary); font-weight: 800; }
        .header-left { display: flex; gap: 8px; align-items: center; background: var(--bg-body); padding: 4px; border-radius: 12px; border: 1px solid var(--border-color); }
        .tools-btn { background: transparent; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; position: relative; z-index: 1; }
        
        .tools-btn.turbo-active { color: var(--success); background: var(--primary-light); animation: pulseGreen 1.5s infinite alternate; border-radius: 50% !important; width: 38px; height: 38px; padding: 0; display: inline-flex; justify-content: center; align-items: center; }
        .tools-btn.turbo-active::after { content: ""; position: absolute; inset: -3px; border-radius: 50%; padding: 2px; background: conic-gradient(from 0deg, transparent 0deg, var(--success) 100deg, transparent 200deg); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: spinBorder 1.0s linear infinite; pointer-events: none; }
        @keyframes spinBorder { 100% { transform: rotate(360deg); } }

        .card, .section { background: var(--bg-card); border-radius: 18px; padding: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 15px; transition: 0.3s; }
        
        .btn-add-room { background: var(--primary); color: white; width: 50px; height: 50px; font-weight: 800; font-size: 1.8rem; border-radius: 50%; border: none; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0, 151, 167, 0.4); display: flex; justify-content: center; align-items: center; padding-bottom: 4px; }
        .btn-add-room:active { transform: scale(0.90); }

        .sec-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .search-box { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); font-weight: bold; margin-bottom: 15px; box-sizing: border-box; }
        
        .room-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; margin-bottom: 10px; display: grid; grid-template-columns: 50px 0.8fr 1fr auto; gap: 8px; align-items: center; border-right: 4px solid transparent; transition: 0.3s; }
        .room-row.status-cleaning { border-right-color: var(--primary); background: rgba(0, 151, 167, 0.05); }
        .room-row.status-checking { border-right-color: var(--warning); background: rgba(241, 196, 15, 0.05); }
        .room-row.status-over { border-right-color: var(--danger); background: rgba(214, 48, 49, 0.05); animation: pulseRed 2s infinite; }
        .room-row.status-acknowledging { border-right-color: var(--upgrade); background: rgba(126, 87, 194, 0.05); }
        
        .room-row.status-maintenance { border: 1px solid var(--maint-card-border); border-right: 5px solid var(--maint-card-border); background: var(--maint-card-bg); box-shadow: 0 4px 10px rgba(156, 39, 176, 0.1); }
        .room-row.status-maintenance .timer-display { color: var(--danger); }
        
        .room-row.status-request { border-right-color: var(--request-color); background: var(--request-light); }
        .room-row.status-request.urgent-req { animation: pulsePurple 2s infinite; }
        .room-row.status-newly-added { background-color: rgba(0, 184, 148, 0.1); border-color: var(--success); animation: pulseGreen 1.5s infinite alternate; }

        @keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(214, 48, 49, 0);} 100% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0);} }
        @keyframes pulseGreen { 0% {box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.3);} 100% {box-shadow: 0 0 0 4px rgba(0, 184, 148, 0);} }
        @keyframes pulsePurple { 0% {box-shadow: 0 0 0 0 rgba(103, 58, 183, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(103, 58, 183, 0);} 100% {box-shadow: 0 0 0 0 rgba(103, 58, 183, 0);} }
        @keyframes pulseRedBackground { 0% {background-color: rgba(214, 48, 49, 0.1);} 50% {background-color: rgba(214, 48, 49, 0.3);} 100% {background-color: rgba(214, 48, 49, 0.1);} }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.08); } 30% { transform: scale(1); } 45% { transform: scale(1.08); } 100% { transform: scale(1); } }
        .btn-urgent-feedback { animation: heartbeat 1.2s infinite; border: 1px solid var(--warning) !important; z-index: 10; }
        .pulse-urgent-box { animation: pulseRedBackground 1.5s infinite; color: var(--danger) !important; border-color: var(--danger) !important; }

        .badge { font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; background: rgba(0,0,0,0.05); color: var(--text-sec); display: block; margin-top: 2px; }
        body.dark-mode .badge { background: rgba(255,255,255,0.1); color: #cbd5e1; }
        .timer-display { font-weight: 800; font-size: 1rem; text-align: center; color: var(--text-sec); }
        .timer-active { color: var(--primary); }
        .timer-danger { color: var(--danger); }
        .timer-req { color: var(--request-color); }
        
        .circle-viz { width: 75px; height: 75px; border-radius: 50%; margin: 0 auto 5px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg-body); box-shadow: 4px 4px 8px rgba(0,0,0,0.1), -4px -4px 8px rgba(255,255,255,0.8); border: var(--circle-width) solid var(--bg-body); transition: 0.3s; line-height: 1.1; }
        .circle-viz h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); }
        .circle-viz span { font-size: 0.6rem; color: var(--text-sec); line-height: 1; margin-top: 2px; }

        .btn-action, .full-btn { border: none; border-radius: 50px; font-weight: bold; cursor: pointer; color: #fff; backdrop-filter: blur(1px); transition: transform 0.1s; }
        .btn-action { padding: 8px 10px; font-size: 0.8rem; }
        .full-btn { width: 100%; padding: 10px; font-size: 1rem; }
        .btn-action:active, .full-btn:active { transform: scale(0.98); }
        .btn-start { background: var(--primary); } .btn-clean-done { background: var(--warning); color: #333; } .btn-finish { background: var(--success); }
        .btn-undo { background: transparent; color: var(--text-sec); border: 1px solid var(--border-color); margin-top: 5px; font-size: 0.7rem; width: 100%; padding: 4px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-undo.active-anim { border-color: var(--primary); color: var(--primary); animation: pulseGreen 1.5s infinite; }
        .btn-undo.urgent-anim { border-color: var(--danger); color: var(--danger); animation: pulseRedBorder 0.8s infinite; }
        @keyframes pulseRedBorder { 0% {box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4);} 100% {box-shadow: 0 0 0 4px rgba(214, 48, 49, 0);} }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px 5px; text-align: center; margin-bottom: 15px; }
        .stat-circle-box { text-align: center; }
        .stat-detail-box { padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; background: var(--bg-body); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        #stat-details-container { padding-top: 15px; margin-top: 15px; border-top: 1px dashed var(--border-color); }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-content { background: var(--bg-card); padding: 15px; border-radius: 20px; width: 90%; max-width: 300px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .modal-label { font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; display: block; color: var(--text-main); }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; background: var(--bg-body); color: var(--text-main); font-size: 0.9rem; }
        
        .modal-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-body); padding: 5px; border-radius: 50px; border: 1px solid var(--border-color); }
        .modal-tab-btn { flex: 1; padding: 8px; border-radius: 50px; border: none; background: transparent; color: var(--text-sec); font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .modal-tab-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .modal-tab-btn.active-req { background: var(--request-color); color: white; }

        .time-input-container { display: flex; gap: 8px; justify-content: space-between; }
        .time-part-box { flex: 1; padding: 12px 5px; border-radius: 12px; background: var(--bg-body); color: var(--text-main); font-weight: 800; font-size: 1.2rem; text-align: center; border: 2px solid var(--border-color); cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .time-part-box span[id^="inp"] { display: inline-block; will-change: transform, opacity; }
        .roll-up { animation: scrollUp 0.2s ease-in-out; } .roll-down { animation: scrollDown 0.2s ease-in-out; }
        @keyframes scrollUp { 0% { transform: translateY(0); opacity: 1; filter: blur(0px); } 49% { transform: translateY(-25px); opacity: 0; filter: blur(2px); } 51% { transform: translateY(25px); opacity: 0; filter: blur(2px); } 100% { transform: translateY(0); opacity: 1; filter: blur(0px); } }
        @keyframes scrollDown { 0% { transform: translateY(0); opacity: 1; filter: blur(0px); } 49% { transform: translateY(25px); opacity: 0; filter: blur(2px); } 51% { transform: translateY(-25px); opacity: 0; filter: blur(2px); } 100% { transform: translateY(0); opacity: 1; filter: blur(0px); } }
        body.dark-mode .time-part-box { color: var(--primary); }
        .time-part-box:active { transform: scale(0.98); } .time-part-box.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
        .time-arrow { position: absolute; top: -5px; right: 50%; transform: translateX(50%); font-size: 0.7rem; color: var(--text-sec); }
        .time-arrow.down { top: auto; bottom: -5px; } .time-input-digital { display: none; }
        
        .toggle-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .toggle-label { font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; color: var(--text-main); }
        .switch { position: relative; display: inline-block; width: 52px; height: 28px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; right: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(-24px); }

        .custom-options-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .option-btn { padding: 11px 12px; border: 2px solid var(--border-color); border-radius: 50px; background: var(--bg-body); color: var(--text-main); font-weight: bold; cursor: pointer; text-align: center; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; transition: 0.2s; }
        .option-btn.selected { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.selected::after { content: 'âœ”'; font-size: 1.2rem; }
        
        .radio-options-grid { display: flex; gap: 8px; margin-bottom: 15px; }
        .radio-btn-box { flex: 1; padding: 6px 5px; border: 1px solid transparent; border-radius: 50px; text-align: center; cursor: pointer; font-weight: bold; color: var(--text-sec); background: var(--bg-body); box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.75rem; transition: 0.2s; }
        .radio-btn-box.selected { background: var(--primary); color: white; box-shadow: 0 4px 8px rgba(0, 151, 167, 0.3); transform: translateY(-1px); }
        .radio-btn-box.selected-maint { background: var(--danger); color: white; box-shadow: 0 4px 8px rgba(214, 48, 49, 0.3); transform: translateY(-1px); }
        
        /* New Archive Styles */
        .archive-container { display: none; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px dashed var(--border-color); }
        .btn-toggle-archive { font-size: 0.7rem; color: var(--text-sec); width: 100%; border: 1px dashed var(--border-color); border-radius: 12px; padding: 5px; margin-top: 10px; cursor: pointer; background: transparent; }

        #dev-footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; font-size: 0.7rem; color: var(--text-sec); background: var(--bg-card); padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        @media (min-width: 768px) { .container { max-width: 700px; margin: 0 auto; } .header-glass { max-width: 700px; } .stats-grid { grid-template-columns: 1fr 1fr 1fr; gap: 20px; } .room-row { grid-template-columns: 50px 1fr 1fr auto; padding: 15px; } }
    </style>
</head>
<body class="worker-mode"> 
    <div class="container">
        <div class="header-glass">
            <div class="header-right"><div class="header-logo" style="display:flex;align-items:center;gap:10px;"><h1>Adora | Ù…ØªØ§Ø¨Ø¹Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h1></div></div>
            <div class="header-left">
                <button onclick="generateDailyReport()" class="tools-btn" title="ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ±">ğŸ“</button>
                <button onclick="toggleTurboMode()" id="turbo-mode-btn" class="tools-btn" title="ÙˆØ¶Ø¹ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ">âš¡</button>
                <button onclick="toggleDarkMode()" class="tools-btn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
                <button class="tools-btn" style="font-size:0.8rem; font-weight:700;" title="Ø§Ù„Ù„ØºØ©">ğŸŒ</button>
            </div>
        </div>

        <div class="worker-view">
            <div id="sync-indicator" style="display: none;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</div>
            <div class="section" style="padding:15px;">
                <div class="sec-title"><span>ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</span><button onclick="showResetModal()" class="tools-btn" style="padding: 2px 6px;">ğŸ—‘ï¸</button></div>
                <div class="stats-grid">
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--danger);"><h3 id="stat-late">0</h3><span>Ù…ØªØ£Ø®Ø±</span></div></div>
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--primary);"><h3 id="stat-active">0</h3><span>Ù†Ø´Ø·</span></div></div>
                    <div class="stat-circle-box"><div class="circle-viz" style="border-color: var(--upgrade);"><h3 id="stat-maint-done">0</h3><span>ØµÙŠØ§Ù†Ø© Ù…Ù†Ø¬Ø²Ø©</span></div></div>
                </div>
                <div id="stat-details-container">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
                        <div class="stat-detail-box" style="border-color:var(--primary);"><span style="display:block; font-size:0.75rem; color:var(--primary); font-weight:bold;">Ø®Ø±ÙˆØ¬ Ù…Ù†Ø¬Ø²</span><strong style="font-size:1.2rem; color:var(--primary);" id="stat-out-done">0</strong></div>
                        <div class="stat-detail-box" style="border-color:var(--upgrade);"><span style="display:block; font-size:0.75rem; color:var(--upgrade); font-weight:bold;">Ø³Ø§ÙƒÙ† Ù…Ù†Ø¬Ø²</span><strong style="font-size:1.2rem; color:var(--upgrade);" id="stat-stay-done">0</strong></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                        <div class="stat-detail-box" id="stat-req-box" style="border-color:var(--request-color); transition: background 0.5s;">
                            <span style="display:block; font-size:0.75rem; color:var(--request-color); font-weight:bold;">ğŸ›ï¸ Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                            <div id="stat-req-text" style="font-size:0.8rem; font-weight:bold; color:var(--text-main); margin-top:5px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>
                        </div>
                        <div class="stat-detail-box" style="border-color:var(--warning);"><span style="display:block; font-size:0.75rem; color:#d4ac0d; font-weight:bold;">ğŸ“ˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ (24Ø³)</span><strong style="font-size:1.2rem; color:#d4ac0d;" id="stat-most-req">--</strong></div>
                    </div>
                </div>
            </div>

            <div class="section" id="guest-requests-section">
                <div class="sec-title" style="color: var(--request-color);"><span>ğŸ›ï¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø²Ù„Ø§Ø¡</span><button onclick="toggleArchive('req')" class="tools-btn" title="Ø§Ù„Ø£Ø±Ø´ÙŠÙ">ğŸ“‚</button></div>
                <div id="guest-requests-active-list" style="margin-bottom:5px;"></div>
                <div id="req-archive-container" class="archive-container">
                    <div style="font-size:0.7rem; color:var(--text-sec); margin-bottom:5px; font-weight:bold;">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</div>
                    <div id="guest-requests-archive-list"></div>
                </div>
            </div>

            <div class="section">
                <div class="sec-title"><span>ğŸšª ØªØªØ¨Ø¹ Ø§Ù„ØºØ±Ù</span><button onclick="openAddModal()" class="btn-add-room" id="add-room-btn">+</button></div>
                <div id="progressSection" style="margin-bottom:10px; display:none;"></div>
                <input type="text" id="search-bar" class="search-box" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©..." oninput="updateSearch()">
                <div id="rooms-container"></div>
            </div>

            <div class="section">
                <div class="sec-title" style="color: var(--danger);"><span>ğŸ› ï¸ Ø§Ù„ØµÙŠØ§Ù†Ø©</span><button onclick="toggleArchive('maint')" class="tools-btn" title="Ø§Ù„Ø£Ø±Ø´ÙŠÙ">ğŸ“‚</button></div>
                <div id="maintenance-active-list" style="margin-bottom:5px;"></div>
                <div id="maint-archive-container" class="archive-container">
                    <div style="font-size:0.7rem; color:var(--text-sec); margin-bottom:5px; font-weight:bold;">Ø£Ø±Ø´ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</div>
                    <div id="maintenance-archive-list"></div>
                </div>
            </div>

            <div class="section">
                <div class="sec-title"><span>ğŸ§¹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§ÙØ© (Ø§Ù„Ù…ÙƒØªÙ…Ù„)</span><button onclick="showLogClearModal()" class="tools-btn" style="padding: 4px 8px;">ğŸ—‘ï¸</button></div>
                <div id="cleaning-log-list" style="font-size:0.8rem; min-height: 50px;"></div>
            </div>
        </div>
    </div>

    <div id="dev-footer-fixed">ØªØ·ÙˆÙŠØ± .. Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ 77aayy@gmail.com</div>

    <div id="addRoomModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-tabs">
                <button onclick="switchAddMode('cleaning')" class="modal-tab-btn active" id="tab-cleaning">ğŸ§¹ Ù†Ø¸Ø§ÙØ©</button>
                <button onclick="switchAddMode('request')" class="modal-tab-btn" id="tab-request">ğŸ›ï¸ Ø·Ù„Ø¨Ø§Øª</button>
            </div>
            <h3 style="color:var(--primary); margin-top:0;" id="modal-title-add">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div style="margin-bottom:15px; text-align:right;">
                <label class="modal-label">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</label>
                <input type="number" id="inpRoomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" oninput="checkDuplicate(); checkRequestWarnings();">
                <div id="room-dup-alert" style="font-size:0.75rem; font-weight:bold; margin-top:8px; padding:5px; border-radius:5px; text-align:right; display:none; white-space: pre-wrap; line-height: 1.4;"></div>
            </div>
            <div id="cleaning-options"><div style="margin-bottom:15px;"><label class="modal-label">Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©</label><input type="hidden" id="inpRoomType"><div class="custom-options-container"><div onclick="setRoomType('out')" class="option-btn" id="opt_out">Ø®Ø±ÙˆØ¬ (ØªÙ†Ø¸ÙŠÙ ÙÙˆØ±ÙŠ)</div><div onclick="setRoomType('stay')" class="option-btn" id="opt_stay">Ø³Ø§ÙƒÙ†</div></div></div></div>
            <div id="request-options" style="display:none; margin-bottom:15px;"><label class="modal-label" style="color:var(--request-color);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label><textarea id="inpRequestDetails" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨ Ø§Ù„Ù†Ø²ÙŠÙ„ Ù‡Ù†Ø§..."></textarea></div>
            
            <div class="toggle-container" style="background: rgba(255, 152, 0, 0.1); border-color: rgba(255, 152, 0, 0.3); margin-bottom: 10px;">
                <div class="toggle-label" style="color: #ef6c00;" id="turbo-label">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (Ø®ØµÙ… 5Ø¯)</div>
                <label class="switch"><input type="checkbox" id="inpSuperTurbo" onchange="toggleTurboInput()"><span class="slider"></span></label>
            </div>

            <div id="stayOptions" style="display:none; background:rgba(0,0,0,0.02); padding:10px; border-radius:10px; margin-bottom:15px; text-align:right;">
                <label class="modal-label">ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø²ÙŠÙ„</label><input type="hidden" id="inpGuestStatus" value="in"><div class="radio-options-grid"><div onclick="setGuestStatus('in')" class="radio-btn-box selected" id="gst_in">Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„</div><div onclick="setGuestStatus('out')" class="radio-btn-box" id="gst_out">Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</div></div>
                <label class="modal-label" id="lblTime" style="margin-top:10px;">ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„Ø¹ÙˆØ¯Ø©</label>
                <div class="time-input-container"><div onclick="changeTimeValue('hour', 1)" id="hourBox" class="time-part-box"><span class="time-arrow">â–²</span><span id="inpHour">12</span><span class="time-arrow down">â–¼</span></div><div onclick="changeTimeValue('minute', 5)" id="minuteBox" class="time-part-box"><span class="time-arrow">â–²</span><span id="inpMinute">00</span><span class="time-arrow down">â–¼</span></div><div onclick="togglePeriod()" id="periodBox" class="time-part-box"><span class="time-arrow">â–²</span><span id="inpPeriodText">Ù…Ø³Ø§Ø¡Ù‹</span><span class="time-arrow down">â–¼</span></div></div>
                <input type="hidden" id="inpHourValue" value="12"><input type="hidden" id="inpMinuteValue" value="0"><input type="hidden" id="inpPeriodValue" value="PM">
            </div>
            
            <button onclick="addNewRoom()" class="full-btn" style="background:var(--success); margin-bottom:10px;" id="confirm-add-room">Ø¥Ø¶Ø§ÙØ© (ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨)</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-add-room">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="rain-prompt-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><h3 style="color:var(--primary); margin-top:0;">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø¯Ø¡</h3><p>Ù…Ø§ Ù‡Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø¶ØºØ· Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ</p><button onclick="commitStartRoom(true)" class="full-btn" style="background:var(--danger); margin-bottom:10px;" id="super-turbo-start">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (-5Ø¯)</button><button onclick="commitStartRoom(false)" class="full-btn" style="background:var(--success);" id="normal-start">ÙˆØ¶Ø¹ Ø¹Ø§Ø¯ÙŠ</button></div></div>
    
    <div id="final-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary);" id="modal-title-text">ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ©</h3>
            <div id="delay-reason-section" style="display:none; margin-bottom:15px; border-bottom:1px dashed var(--border-color); padding-bottom:10px;">
                <label class="modal-label" style="color:var(--danger); font-size:1rem;">âš ï¸ Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
                <input type="hidden" id="modal-delay">
                <div class="custom-options-container">
                    <div onclick="setDelayReason('Ø¶ØºØ· Ø¹Ù…Ù„')" class="option-btn" id="dly_work">Ø¶ØºØ· Ø¹Ù…Ù„</div>
                    <div onclick="setDelayReason('Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©')" class="option-btn" id="dly_room">Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©</div>
                    <div onclick="setDelayReason('Ø³Ø¨Ø¨ Ø¢Ø®Ø±')" class="option-btn" id="dly_other">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</div>
                </div>
            </div>
            <label class="modal-label">Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ©:</label>
            <input type="hidden" id="modal-notes" value="Ø¬Ø§Ù‡Ø²Ø©">
            <div class="radio-options-grid">
                <div onclick="setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©')" class="radio-btn-box selected" id="st_ready">Ø¬Ø§Ù‡Ø²Ø© ØªÙ…Ø§Ù…Ø§Ù‹ âœ…</div>
                <div onclick="setRoomStatus('ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©')" class="radio-btn-box" id="st_maint">ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø© ğŸ› ï¸</div>
            </div>
            <div id="maintenance-fields" style="border: 1px dashed var(--warning); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none;">
                <label class="modal-label" style="color:var(--danger);">ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ):</label>
                <textarea id="repair-details-input" placeholder="Ø§ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..."></textarea>
                <label class="modal-label">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©):</label>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <label id="camera-label" for="modal-img-camera-input">ğŸ“¸ Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
                    <input type="file" accept="image/*" capture="environment" id="modal-img-camera-input">
                </div>
            </div>
            <div class="toggle-container" style="background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3); margin-top: 15px;">
                <div class="toggle-label" style="color: #2e7d32;"><span style="font-size:1.4rem">ğŸ“²</span> Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</div>
                <label class="switch"><input type="checkbox" id="inpSendWhatsapp"><span class="slider"></span></label>
            </div>
            <button onclick="confirmFinishRoom()" class="full-btn" id="btn_confirm_finish" style="background:var(--success); margin-top:10px;">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            <button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-finish-room">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
    
    <div id="complete-maint-modal" class="modal-overlay"><div class="modal-content"><h3 style="margin-top:0; color:var(--success);">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù…Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h3><div id="maint-room-num-display" style="font-size:1.2rem; font-weight:bold; margin-bottom:15px; color:var(--text-main);">ØºØ±ÙØ© XXX</div><label class="modal-label">ØµÙˆØ±Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©):</label><div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;"><label id="maint-camera-label" for="maint-img-camera-input" class="full-btn" style="background:var(--primary);">ğŸ“¸ Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label><input type="file" accept="image/*" capture="environment" id="maint-img-camera-input" style="display:none;"></div><button onclick="confirmCompleteMaintenance()" class="full-btn" id="btn_confirm_maint_finish" style="background:var(--success); margin-top:10px;">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-complete-maint">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="password-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><h3 style="color:var(--danger); margin-top:0;">ØªØ­Ù‚Ù‚ Ø£Ù…Ù†ÙŠ</h3><p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p><input type="password" id="admin-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; margin-bottom:15px;" /><button onclick="checkPasswordAndAction()" id="confirm-reset-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;">ØªØ£ÙƒÙŠØ¯</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-password">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="action-confirm-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><h3 id="confirm-title" style="color:var(--danger); margin-top:0;">ØªØ£ÙƒÙŠØ¯</h3><p id="confirm-message" style="font-size:0.9rem;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p><button id="confirm-yes-btn" class="full-btn" style="background:var(--success); margin-bottom:10px;">Ù†Ø¹Ù…ØŒ Ø£Ø¤ÙƒØ¯</button><button onclick="closeAllModals()" class="full-btn" style="background:#ddd; color:#333;" id="cancel-confirm">Ø¥Ù„ØºØ§Ø¡</button></div></div>

    <script>
        // ğŸ”¥ 1. GLOBAL SETTINGS
        const CONFIG = { 
            firebase: { apiKey: "AIzaSyDJ8EWvicHqjvX-g1-19oS5h-VUQjRjtG8", authDomain: "abella-all.firebaseapp.com", databaseURL: "https://abella-all-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "abella-all", storageBucket: "abella-all.firebasestorage.app", messagingSenderId: "608492409476", appId: "1:608492409476:web:6d6ac8e85dd2fba1b328d1" }, 
            imgbbKey: "a7ec1c5e56839fcc6e0b6bda38257f05", 
            adminPass: "fahd5", 
            times: { OUT_NORM: 35 * 60000, OUT_TURBO: 30 * 60000, STAY_NORM: 25 * 60000, STAY_TURBO: 20 * 60000, TRAVEL: 15 * 60000, PREP_ALERT: 15 * 60000, CHECKING: 15 * 60000 } 
        };
        
        let appState = { rooms: [], log: [], activeMaintenance: [], completedMaintenanceLog: [], guestRequests: [], guestRequestsLog: [], turbo: false, searchText: "" };
        let currentAddMode = 'cleaning';
        let db, dbRef;
        let tempRoomId = null, activeRoomId = null, activeMaintId = null, pendingAction = null;

        // ğŸ”¥ 2. INITIALIZATION & HELPER FUNCTIONS
        function initApp() {
            // Restore from LocalStorage immediately on load
            const saved = localStorage.getItem('abella_hybrid_v6');
            if (saved) {
                try {
                    appState = JSON.parse(saved);
                } catch(e) { console.error("Error loading data", e); }
            }
            render();
        }
        window.onload = initApp;

        function initTimeFields() {
            const now = new Date();
            let h = now.getHours();
            const m = now.getMinutes();
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; 
            const mStr = Math.ceil(m / 5) * 5; 
            document.getElementById('inpHourValue').value = h;
            document.getElementById('inpHour').innerText = h;
            document.getElementById('inpMinuteValue').value = mStr >= 60 ? 0 : mStr;
            document.getElementById('inpMinute').innerText = (mStr >= 60 ? 0 : mStr).toString().padStart(2, '0');
            document.getElementById('inpPeriodValue').value = period;
            document.getElementById('inpPeriodText').innerText = period === 'PM' ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
        }

        function changeTimeValue(type, step) {
            if (type === 'hour') {
                let val = parseInt(document.getElementById('inpHourValue').value);
                val += step; if (val > 12) val = 1; if (val < 1) val = 12;
                document.getElementById('inpHourValue').value = val;
                document.getElementById('inpHour').innerText = val;
            } else if (type === 'minute') {
                let val = parseInt(document.getElementById('inpMinuteValue').value);
                val += step; if (val >= 60) val = 0; if (val < 0) val = 55;
                document.getElementById('inpMinuteValue').value = val;
                document.getElementById('inpMinute').innerText = val.toString().padStart(2, '0');
            }
        }

        function togglePeriod() {
            let val = document.getElementById('inpPeriodValue').value;
            val = val === 'AM' ? 'PM' : 'AM';
            document.getElementById('inpPeriodValue').value = val;
            document.getElementById('inpPeriodText').innerText = val === 'PM' ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
        }

        function checkDuplicate() {
            const num = document.getElementById('inpRoomNum').value;
            const exists = appState.rooms.find(r => r.num == num);
            const alertBox = document.getElementById('room-dup-alert');
            if (exists) {
                alertBox.style.display = 'block'; alertBox.style.background = 'rgba(214, 48, 49, 0.1)'; alertBox.style.color = '#d63031';
                alertBox.innerText = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ØºØ±ÙØ© ${num} Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!`;
            } else { alertBox.style.display = 'none'; }
        }

        function checkRequestWarnings() { /* Placeholder */ }
        function toggleArchive(type) {
            const id = type === 'req' ? 'req-archive-container' : 'maint-archive-container';
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        // ğŸ”¥ 3. MAIN FUNCTIONS
        function openAddModal() { 
            document.getElementById('inpRoomNum').value = ''; 
            document.getElementById('room-dup-alert').style.display = 'none'; 
            document.getElementById('inpRoomType').value = ''; 
            document.getElementById('opt_out').classList.remove('selected'); 
            document.getElementById('opt_stay').classList.remove('selected'); 
            document.getElementById('stayOptions').style.display = 'none'; 
            document.getElementById('inpSuperTurbo').checked = false; 
            document.getElementById('inpRequestDetails').value = ''; 
            
            initTimeFields(); 
            switchAddMode('cleaning'); 
            document.getElementById('addRoomModal').style.display = 'flex'; 
        }

        function switchAddMode(mode) { 
            currentAddMode = mode; 
            document.getElementById('tab-cleaning').classList.remove('active', 'active-req'); 
            document.getElementById('tab-request').classList.remove('active', 'active-req'); 
            
            const isUrgent = document.getElementById('inpSuperTurbo').checked;
            
            if (mode === 'cleaning') { 
                document.getElementById('tab-cleaning').classList.add('active'); 
                document.getElementById('cleaning-options').style.display = 'block'; 
                document.getElementById('request-options').style.display = 'none'; 
                document.getElementById('stayOptions').style.display = 'none'; 
                document.getElementById('modal-title-add').innerText = 'Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©'; 
                document.getElementById('modal-title-add').style.color = 'var(--primary)'; 
                document.getElementById('turbo-label').innerText = 'ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ (Ø®ØµÙ… 5Ø¯)'; 
            } else { 
                document.getElementById('tab-request').classList.add('active-req'); 
                document.getElementById('cleaning-options').style.display = 'none'; 
                document.getElementById('request-options').style.display = 'block'; 
                document.getElementById('stayOptions').style.display = isUrgent ? 'none' : 'block'; 
                document.getElementById('lblTime').innerText = 'ÙˆÙ‚Øª ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨'; 
                document.getElementById('modal-title-add').innerText = 'ğŸ›ï¸ Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'; 
                document.getElementById('modal-title-add').style.color = 'var(--request-color)'; 
                document.getElementById('turbo-label').innerText = 'ğŸ”¥ Ø·Ù„Ø¨ Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹'; 
            } 
        }

        function setRoomType(type) { 
            document.getElementById('inpRoomType').value = type; 
            document.getElementById('opt_out').classList.remove('selected'); 
            document.getElementById('opt_stay').classList.remove('selected'); 
            
            if (type === 'out') { 
                document.getElementById('opt_out').classList.add('selected'); 
                document.getElementById('stayOptions').style.display = 'none'; 
            } else { 
                document.getElementById('opt_stay').classList.add('selected'); 
                document.getElementById('stayOptions').style.display = 'block'; 
                document.getElementById('lblTime').innerText = 'ÙˆÙ‚Øª Ø¹ÙˆØ¯Ø© Ø§Ù„Ù†Ø²ÙŠÙ„'; 
            } 
        }

        function setGuestStatus(status) { 
            document.getElementById('inpGuestStatus').value = status; 
            document.getElementById('gst_in').classList.remove('selected'); 
            document.getElementById('gst_out').classList.remove('selected'); 
            
            if (status === 'in') { 
                document.getElementById('gst_in').classList.add('selected'); 
                if(currentAddMode==='cleaning') document.getElementById('lblTime').innerText = 'ÙˆÙ‚Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨'; 
            } else { 
                document.getElementById('gst_out').classList.add('selected'); 
                if(currentAddMode==='cleaning') document.getElementById('lblTime').innerText = 'ÙˆÙ‚Øª Ø¹ÙˆØ¯Ø© Ø§Ù„Ù†Ø²ÙŠÙ„'; 
            } 
        }

        function addNewRoom() {
            const num = document.getElementById('inpRoomNum').value; 
            if (!num) { showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©.', 'warning'); return; }

            // Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨
            if (currentAddMode === 'request') {
                const details = document.getElementById('inpRequestDetails').value; 
                if (!details) { showAlert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.', 'warning'); return; }
                
                const isUrgent = document.getElementById('inpSuperTurbo').checked;
                let displayTime = "ÙÙˆØ±ÙŠ";
                if (!isUrgent) {
                    const hVal = document.getElementById('inpHourValue').value; 
                    const mVal = document.getElementById('inpMinuteValue').value; 
                    const period = document.getElementById('inpPeriodValue').value;
                    displayTime = `${hVal.padStart(2, '0')}:${mVal.padStart(2, '0')} ${period === 'AM' ? 'ØµØ¨Ø§Ø­Ø§Ù‹' : 'Ù…Ø³Ø§Ø¡Ù‹'}`;
                } else {
                    displayTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                }
                
                const newRequest = { id: Date.now(), num, details, schedTime: displayTime, isUrgent, startTime: Date.now() };
                if(!appState.guestRequests) appState.guestRequests = [];
                appState.guestRequests.push(newRequest); 
                saveData(); 
                closeAllModals();
                
                let waMsg = `*ğŸ›ï¸ Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„ Ø¬Ø¯ÙŠØ¯*\nØºØ±ÙØ©: ${num}\nØ§Ù„Ø·Ù„Ø¨: ${details}\nØ§Ù„ØªÙˆÙ‚ÙŠØª: ${displayTime}`; 
                if (isUrgent) waMsg += `\nğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø©: Ø¹Ø§Ø¬Ù„ Ø¬Ø¯Ø§Ù‹`; 
                
                // USE HREF INSTEAD OF OPEN TO FIX MOBILE BLOCKING
                window.location.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© ØªÙ†Ø¸ÙŠÙ
            const type = document.getElementById('inpRoomType').value; 
            const isSuper = document.getElementById('inpSuperTurbo').checked; 
            if (!type) { showAlert('Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„ØºØ±ÙØ© (Ø®Ø±ÙˆØ¬/Ø³Ø§ÙƒÙ†).', 'warning'); return; }
            
            const activeRoom = appState.rooms.find(room => room.num == num); 
            const activeMaintRoom = appState.activeMaintenance.find(room => room.num == num);
            if (activeRoom || activeMaintRoom) { showAlert(`Ø§Ù„ØºØ±ÙØ© Ø±Ù‚Ù… ${num} Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©.`, 'error'); return; }
            
            const newRoom = { id: Date.now(), num, type, status: 'acknowledging', startTime: Date.now(), deadline: Date.now() + CONFIG.times.TRAVEL, guestStatus: 'out', undoExpiry: Date.now() + 15000, historyLogs: [{ action: 'Ø¯Ø®ÙˆÙ„', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }], isSuperTurbo: isSuper, isNew: true };
            
            let waMsg = ""; 
            if (type === 'out') { waMsg = `*Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø®Ø±ÙˆØ¬*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙ†Ø¸Ø§ÙØ© Ø¹Ø§Ø¬Ù„Ø©!`; } 
            else { 
                const gStat = document.getElementById('inpGuestStatus').value; 
                const hVal = document.getElementById('inpHourValue').value; 
                const mVal = document.getElementById('inpMinuteValue').value; 
                const period = document.getElementById('inpPeriodValue').value; 
                const displayTime = `${hVal.padStart(2, '0')}:${mVal.padStart(2, '0')} ${period === 'AM' ? 'ØµØ¨Ø§Ø­Ø§Ù‹' : 'Ù…Ø³Ø§Ø¡Ù‹'}`; 
                newRoom.schedTime = displayTime; 
                if (gStat === 'in') waMsg = `*Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† (Ø¨Ø§Ù„Ø¯Ø§Ø®Ù„)*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙŠØ·Ù„Ø¨ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø©: ${displayTime}`; 
                else waMsg = `*Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† (Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬)*\nØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©: ${num}\nÙŠØ¹ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¹Ø©: ${displayTime}`; 
                
                let h = parseInt(hVal); const m = parseInt(mVal); if (period === 'PM' && h !== 12) h += 12; if (period === 'AM' && h === 12) h = 0; 
                const targetDate = new Date(); targetDate.setHours(h, m, 0, 0); 
                let targetTs = targetDate.getTime(); if (targetTs < Date.now() - 3600000) targetTs += 86400000; 
                newRoom.guestStatus = gStat; 
                if (gStat === 'out') { newRoom.startTime = targetTs - CONFIG.times.PREP_ALERT; newRoom.status = (newRoom.startTime > Date.now()) ? 'scheduled' : 'acknowledging'; } 
                else { newRoom.startTime = targetTs; newRoom.status = (newRoom.startTime > Date.now()) ? 'scheduled' : 'acknowledging'; } 
            }
            
            appState.rooms.push(newRoom); 
            saveData(); 
            closeAllModals(); 
            
            // USE HREF INSTEAD OF OPEN
            window.location.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
            
            setTimeout(() => { 
                const room = appState.rooms.find(r => r.id === newRoom.id); 
                if (room) { delete room.isNew; saveData(); } 
            }, 5000);
        }

        function saveData() { 
            localStorage.setItem('abella_hybrid_v6', JSON.stringify(appState));
            if (dbRef) { 
                document.getElementById('sync-indicator').style.display = 'block'; 
                dbRef.set(appState).then(() => { 
                    setTimeout(() => { document.getElementById('sync-indicator').style.display = 'none'; }, 500); 
                }).catch(error => { console.error(error); document.getElementById('sync-indicator').style.display = 'none'; }); 
            } 
            render(); 
        }

        function render() { 
            renderRooms(); 
            renderAllLogs(); 
            renderGuestRequests(); 
            updateStats(); 
        }

        function renderRooms() {
            let activeRooms = appState.rooms.filter(room => room.num.includes(appState.searchText));
            activeRooms.sort((a, b) => { const statusOrder = { 'overdue': 0, 'acknowledging': 1, 'cleaning': 2, 'checking': 3, 'scheduled': 4 }; if (statusOrder[a.status] !== statusOrder[b.status]) return statusOrder[a.status] - statusOrder[b.status]; return (a.deadline - Date.now()) - (b.deadline - Date.now()); });
            
            document.getElementById('rooms-container').innerHTML = activeRooms.map(room => {
                const isScheduled = room.status === 'scheduled';
                const badge = room.type === 'out' ? 'Ø®Ø±ÙˆØ¬' : (room.guestStatus === 'in' ? 'Ù†Ø²ÙŠÙ„ Ø¯Ø§Ø®Ù„' : 'Ù†Ø²ÙŠÙ„ Ø®Ø§Ø±Ø¬');
                const undoLeft = room.undoExpiry ? Math.ceil((room.undoExpiry - Date.now())/1000) : 0; 
                const isUrgent = undoLeft > 0 && undoLeft <= 5;
                const undoBtn = room.undoExpiry ? `<button class="btn-undo ${isUrgent ? 'urgent-anim' : 'active-anim'}" onclick="undoRoom(${room.id})">ØªØ±Ø§Ø¬Ø¹ (${undoLeft}) â†©</button>` : '';
                const urgentClass = (room.deadline - Date.now() < 5000 && room.deadline > Date.now()) ? 'btn-urgent-feedback' : '';
                
                let actionBtn = '';
                if (isScheduled) actionBtn = `<button class="btn-action btn-start" onclick="promptStartRoom(${room.id})">Ø¨Ø¯Ø¡ Ø§Ù„Ø¢Ù†</button>`;
                else if (room.status === 'acknowledging') actionBtn = `<button class="btn-action btn-start ${urgentClass}" onclick="promptAction(${room.id}, 'ack')">ÙˆØµÙ„Øª Ù„Ù„ØºØ±ÙØ© ğŸƒ</button>`;
                else if (room.status === 'cleaning') actionBtn = `<button class="btn-action btn-clean-done ${urgentClass}" onclick="promptAction(${room.id}, 'clean')">ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ ğŸ§¹</button>`;
                else if (room.status === 'checking') actionBtn = `<button class="btn-action btn-finish ${urgentClass}" onclick="openFinishModal(${room.id})">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªÙˆØ«ÙŠÙ‚ âœ…</button>`;
                else if (room.status === 'overdue') actionBtn = `<button class="btn-action btn-finish" style="background:var(--danger)" onclick="openFinishModal(${room.id})">Ø¥Ù†Ù‡Ø§Ø¡ (ØªØ£Ø®ÙŠØ±)</button>`;
                
                const newClass = room.isNew ? ' status-newly-added' : '';
                return `<div class="room-row status-${room.status}${newClass}"><div class="timer-display" id="timer-${room.id}">--:--</div><div style="text-align:center"><div style="font-weight:800; font-size:1.2rem;">${room.num}</div></div><div style="text-align:center"><span class="badge">${badge}</span>${isScheduled ? `<div class="timer-sched">ÙˆÙ‚Øª: ${room.schedTime}</div>` : ''}${room.isSuperTurbo ? '<span style="color:#ef6c00; font-size:0.6rem;">ğŸš€ Ø³ÙˆØ¨Ø± ØªÙŠØ±Ø¨Ùˆ</span>' : ''}</div><div style="display:flex; flex-direction:column; gap:2px;">${actionBtn}${undoBtn}</div></div>`;
            }).join(''); 
            
            updateTimersDOM();
        }

        function renderGuestRequests() {
            const container = document.getElementById('guest-requests-active-list');
            const archiveContainer = document.getElementById('guest-requests-archive-list');
            
            // 1. Active Requests
            if (!appState.guestRequests || appState.guestRequests.length === 0) { 
                container.innerHTML = '<p style="text-align:center;color:var(--text-sec); font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</p>'; 
            } else {
                appState.guestRequests.sort((a, b) => (b.isUrgent ? 1 : 0) - (a.isUrgent ? 1 : 0));
                container.innerHTML = appState.guestRequests.map(req => {
                    const badge = req.isUrgent ? 'ğŸ”¥ Ø¹Ø§Ø¬Ù„' : 'Ø·Ù„Ø¨'; 
                    const urgentClass = req.isUrgent ? 'urgent-req' : '';
                    return `<div class="room-row status-request ${urgentClass}"><div class="timer-display timer-req" id="req-timer-${req.id}">0:00:00</div><div style="text-align:center"><div style="font-weight:800; font-size:1.2rem;">${req.num}</div></div><div style="text-align:center"><span class="badge" style="background:var(--request-color); color:white;">${badge}</span><div style="font-size:0.75rem; font-weight:bold; margin-top:2px; color:var(--text-main);">${req.details}</div><div style="font-size:0.6rem; color:var(--text-sec);">ÙˆÙ‚Øª: ${req.schedTime}</div></div><div><button class="btn-action" style="background:var(--success)" onclick="completeRequest(${req.id})">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ…</button></div></div>`;
                }).join(''); 
                renderGuestRequestTimers();
            }

            // 2. Archived Requests
            if (!appState.guestRequestsLog || appState.guestRequestsLog.length === 0) {
                archiveContainer.innerHTML = '<p style="text-align:center;color:var(--text-sec); font-size:0.7rem;">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</p>';
            } else {
                appState.guestRequestsLog.sort((a,b) => b.id - a.id);
                archiveContainer.innerHTML = appState.guestRequestsLog.map(item => createLogRow(item)).join('');
            }
        }

        function renderAllLogs() {
            // 1. Cleaning Log (Strictly Cleaning)
            const cleaningLog = appState.log || [];
            cleaningLog.sort((a, b) => b.id - a.id || 0); // safe sort
            renderLogSection(cleaningLog, 'cleaning-log-list', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªÙ†Ø¸ÙŠÙ');
            
            // 2. Maintenance Active
            const activeMaintHTML = appState.activeMaintenance.map(m => renderActiveMaintenanceRow(m)).join('');
            document.getElementById('maintenance-active-list').innerHTML = activeMaintHTML || '<p style="text-align:center;color:var(--text-sec);font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·Ø©</p>';
            
            // 3. Maintenance Archive
            const maintLog = appState.completedMaintenanceLog || [];
            maintLog.sort((a, b) => b.id - a.id);
            const maintArchiveContainer = document.getElementById('maintenance-archive-list');
            if (maintLog.length === 0) {
                maintArchiveContainer.innerHTML = '<p style="text-align:center;color:var(--text-sec); font-size:0.7rem;">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</p>';
            } else {
                maintArchiveContainer.innerHTML = maintLog.map(item => createLogRow(item)).join('');
            }
        }

        function renderLogSection(data, elementId, emptyMsg) {
            const listEl = document.getElementById(elementId);
            if (!data || data.length === 0) { listEl.innerHTML = `<p style="text-align:center;color:var(--text-sec);">${emptyMsg}</p>`; return; }
            const recent = data.slice(0, 10);
            listEl.innerHTML = recent.map(item => createLogRow(item)).join('');
        }

        function createLogRow(item) {
            const historyText = item.history ? item.history.map(h => `${h.action}: ${h.time}`).join(' | ') : `ÙˆÙ‚Øª: ${item.time}`;
            let statusBadge = item.status; 
            if (item.finishImg) statusBadge = 'ØµÙŠØ§Ù†Ø© Ù…Ù†Ø¬Ø²Ø© âœ…'; else if (item.maintDesc && !item.finishImg && item.type !== 'request') statusBadge = 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø© ğŸ› ï¸'; 
            if (item.type === 'request') statusBadge = 'Ø·Ù„Ø¨ Ù…Ù†ÙØ° âœ…';
            
            let maintDetails = ''; 
            if (item.maintDesc) { maintDetails += `<div style="font-size:0.7rem; color:var(--danger); margin-top:2px;">**${item.type === 'request' ? 'Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¹Ø·Ù„'}:** ${item.maintDesc}</div>`; if (item.maintImg) maintDetails += `<a href="${item.maintImg}" target="_blank" class="btn-undo" style="border-color:var(--danger); color:var(--danger); margin-top:5px; padding:4px;">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</a>`; } 
            if (item.finishImg) { maintDetails += `<div style="font-size:0.7rem; color:var(--success); margin-top:2px;">**Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙÙŠ:** ${item.timeFinish}</div>`; maintDetails += `<a href="${item.finishImg}" target="_blank" class="btn-undo" style="border-color:var(--success); color:var(--success); margin-top:5px; padding:4px;">ØµÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</a>`; }
            return `<div style="border-bottom:1px solid var(--border-color); padding:8px; display:flex; flex-direction:column;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><strong>${item.num}</strong>${item.isLate ? '<span style="color:var(--danger); font-size:0.7rem"> (ØªØ£Ø®ÙŠØ±)</span>' : ''}</div><div style="text-align:left"><span class="badge">${statusBadge}</span></div></div><div style="font-size:0.65rem; color:var(--text-sec); margin-top:4px;">${historyText}</div>${maintDetails}</div>`;
        }

        function renderActiveMaintenanceRow(maint) { 
            const timeStr = new Date(maint.startTime).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }); 
            return `<div class="room-row status-maintenance"><div class="timer-display" id="maint-timer-${maint.id}">0:00:00</div><div style="text-align:center"><div style="font-weight:800; font-size:1.2rem;">${maint.num}</div></div><div style="text-align:center"><span class="badge" style="background:var(--danger); color:white;">ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·Ø©</span><div style="font-size:0.65rem; color:var(--text-sec); margin-top:2px;">${timeStr}</div></div><div style="display:flex; flex-direction:column; gap:2px;"><button class="btn-action btn-finish" style="background:var(--success)" onclick="openCompleteMaintenanceModal(${maint.id})">Ø¥Ù†Ù‡Ø§Ø¡</button>${maint.maintImg ? `<a href="${maint.maintImg}" target="_blank" class="btn-undo" style="border-color:var(--danger); color:var(--danger); margin-top:5px; padding:4px;">ØµÙˆØ±Ø©</a>` : ''}</div></div>`; 
        }
        function renderGuestRequestTimers() { if (!appState.guestRequests) return; appState.guestRequests.forEach(req => { const el = document.getElementById(`req-timer-${req.id}`); if (!el) return; const diff = Date.now() - req.startTime; const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }); }
        function renderActiveMaintenance() { appState.activeMaintenance.forEach(maint => { const el = document.getElementById(`maint-timer-${maint.id}`); if (!el) return; const diff = Date.now() - maint.startTime; const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); el.innerText = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }); }
        function renderUndoCountdowns() { appState.rooms.forEach(room => { const btn = document.querySelector(`[onclick="undoRoom(${room.id})"]`); if (btn && room.undoExpiry) { const left = Math.ceil((room.undoExpiry - Date.now()) / 1000); if (left <= 0) { btn.style.display = 'none'; return; } btn.innerText = `ØªØ±Ø§Ø¬Ø¹ (${left}) â†©`; if (left <= 5) { btn.classList.remove('active-anim'); btn.classList.add('urgent-anim'); } else { btn.classList.add('active-anim'); btn.classList.remove('urgent-anim'); } } }); }
        
        function updateStats() { 
            const totalLog = [...appState.log, ...appState.completedMaintenanceLog]; 
            document.getElementById('stat-active').innerText = appState.rooms.filter(room => room.status !== 'scheduled').length; 
            document.getElementById('stat-late').innerText = appState.rooms.filter(room => room.status === 'overdue').length; 
            document.getElementById('stat-maint-done').innerText = appState.completedMaintenanceLog ? appState.completedMaintenanceLog.length : 0;
            
            const reqBox = document.getElementById('stat-req-box');
            const reqText = document.getElementById('stat-req-text');
            const activeReqs = appState.guestRequests || [];
            if (activeReqs.length > 0) {
                const latest = activeReqs[activeReqs.length - 1]; 
                reqText.innerText = `${latest.num} ${latest.details.substring(0, 10)}..`;
                reqBox.classList.add('pulse-urgent-box');
                reqBox.style.borderColor = 'var(--danger)';
            } else {
                reqText.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª';
                reqBox.classList.remove('pulse-urgent-box');
                reqBox.style.borderColor = 'var(--request-color)';
            }
            
            const allReqs = [...(appState.guestRequests || []), ...(appState.guestRequestsLog || [])];
            if (allReqs.length > 0) {
                const counts = {}; allReqs.forEach(r => { counts[r.num] = (counts[r.num] || 0) + 1; });
                const mostReq = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                document.getElementById('stat-most-req').innerText = mostReq;
            } else { document.getElementById('stat-most-req').innerText = "--"; }
        }
        function updateTimersDOM() { appState.rooms.forEach(room => { const el = document.getElementById(`timer-${room.id}`); if (!el) return; if (room.status === 'scheduled') { el.innerText = 'Ù…Ø¬Ø¯ÙˆÙ„'; el.style.color = '#999'; return; } const diff = room.deadline - Date.now(); const m = Math.floor(Math.abs(diff) / 60000); const s = Math.floor((Math.abs(diff) % 60000) / 1000); el.innerText = `${diff < 0 ? '+' : ''}${m}:${s.toString().padStart(2, '0')}`; el.className = `timer-display ${diff < 0 ? 'timer-danger' : 'timer-active'}`; }); }
        function renderProgress() { const activeRooms = appState.rooms.filter(room => ['acknowledging', 'cleaning', 'checking', 'overdue'].includes(room.status)); if (activeRooms.length === 0) { document.getElementById('progressSection').style.display = 'none'; return; } document.getElementById('progressSection').style.display = 'block'; document.getElementById('progressSection').innerHTML = activeRooms.map(room => { let total = CONFIG.times.TRAVEL; if (room.status === 'cleaning') { total = appState.turbo ? CONFIG.times.OUT_TURBO : CONFIG.times.OUT_NORM; if (room.type === 'stay') total = appState.turbo ? CONFIG.times.STAY_TURBO : CONFIG.times.STAY_NORM; if (room.isSuperTurbo) total -= (5 * 60000); } else if (room.status === 'checking') total = CONFIG.times.CHECKING; const elapsed = Date.now() - room.startTime; const pct = Math.min(100, (elapsed / total) * 100); let color = 'var(--primary)', label = 'ØªÙ†Ø¸ÙŠÙ', icon = 'ğŸ§¹'; if (room.status === 'acknowledging') { color = 'var(--upgrade)'; label = 'Ø§Ù†ØªÙ‚Ø§Ù„'; icon = 'ğŸƒ'; } else if (room.status === 'checking') { color = 'var(--warning)'; label = 'ÙØ­Øµ'; icon = 'ğŸ”'; } else if (room.status === 'overdue') { color = 'var(--danger)'; label = 'ØªØ£Ø®ÙŠØ±'; icon = 'ğŸš¨'; } return `<div style="display:flex; align-items:center; margin-bottom:5px; background:var(--bg-card); padding:5px; border-radius:8px; border:1px solid var(--border-color);"><div style="font-weight:bold; font-size:0.8rem; width:40px;">${room.num}</div><div style="flex:1; height:8px; background:var(--bg-body); border-radius:4px; margin:0 10px; overflow:hidden;"><div style="height:100%; width:${pct}%; background:${color}; transition:width 1s linear;"></div></div><div style="font-size:0.7rem; color:${color}; font-weight:bold;">${icon} ${label}</div></div>`; }).join(''); }

        // ğŸ”¥ 3. UTILITY FUNCTIONS
        function undoRoom(id) { const room = appState.rooms.find(r => r.id === id); if (room && room.undoExpiry) { appState.rooms = appState.rooms.filter(r => r.id !== id); saveData(); } }
        function promptStartRoom(id) { tempRoomId = id; if (appState.turbo) commitStartRoom(true); else document.getElementById('rain-prompt-modal').style.display = 'flex'; }
        function commitStartRoom(isTurbo) { document.getElementById('rain-prompt-modal').style.display = 'none'; const room = appState.rooms.find(r => r.id === tempRoomId); if (room) { room.status = 'acknowledging'; room.startTime = Date.now(); room.deadline = Date.now() + CONFIG.times.TRAVEL; room.undoExpiry = Date.now() + 15000; room.isSuperTurbo = isTurbo; saveData(); } }
        function promptAction(id, type) { tempRoomId = id; const messages = { 'ack': 'Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ø¸ÙŠÙØŸ', 'clean': 'Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­ØµØŸ' }; document.getElementById('confirm-message').innerText = messages[type]; const btn = document.getElementById('confirm-yes-btn'); btn.innerText = 'Ù†Ø¹Ù…ØŒ Ø£Ø¤ÙƒØ¯'; btn.style.background = 'var(--success)'; btn.onclick = () => executePhase(id, type); document.getElementById('confirm-title').innerText = 'ØªØ£ÙƒÙŠØ¯'; document.getElementById('confirm-title').style.color = 'var(--danger)'; document.getElementById('action-confirm-modal').style.display = 'flex'; }
        function executePhase(id, type) { document.getElementById('action-confirm-modal').style.display = 'none'; const room = appState.rooms.find(r => r.id === id); if (!room) return; const now = Date.now(); if (type === 'ack') { room.status = 'cleaning'; room.startTime = now; let duration = appState.turbo ? CONFIG.times.OUT_TURBO : CONFIG.times.OUT_NORM; if (room.type === 'stay') duration = appState.turbo ? CONFIG.times.STAY_TURBO : CONFIG.times.STAY_NORM; if (room.isSuperTurbo) duration -= (5 * 60000); room.deadline = now + duration; if (!room.historyLogs) room.historyLogs = []; room.historyLogs.push({ action: 'Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }); } else if (type === 'clean') { room.status = 'checking'; room.startTime = now; room.deadline = now + CONFIG.times.CHECKING; room.historyLogs.push({ action: 'ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }); } room.undoExpiry = now + 15000; saveData(); }
        
        function openFinishModal(id) { 
            activeRoomId = id; 
            const room = appState.rooms.find(r => r.id === id); 
            if (!room) return; 
            
            document.getElementById('modal-title-text').innerText = `ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„ØºØ±ÙØ©`; 
            const isLate = room.status === 'overdue'; 
            document.getElementById('delay-reason-section').style.display = isLate ? 'block' : 'none'; 
            document.getElementById('modal-delay').value = ''; 
            ['dly_work', 'dly_room', 'dly_other'].forEach(id => document.getElementById(id).classList.remove('selected')); 
            document.getElementById('repair-details-input').value = ''; 
            document.getElementById('modal-img-camera-input').value = ''; 
            document.getElementById('inpSendWhatsapp').checked = false; 
            setRoomStatus('Ø¬Ø§Ù‡Ø²Ø©'); 
            document.getElementById('final-modal').style.display = 'flex'; 
        }

        function setDelayReason(reason) { 
            document.getElementById('modal-delay').value = reason; 
            ['dly_work', 'dly_room', 'dly_other'].forEach(id => document.getElementById(id).classList.remove('selected')); 
            if (reason === 'Ø¶ØºØ· Ø¹Ù…Ù„') document.getElementById('dly_work').classList.add('selected');
            else if (reason === 'Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØºØ±ÙØ©') document.getElementById('dly_room').classList.add('selected');
            else if (reason === 'Ø³Ø¨Ø¨ Ø¢Ø®Ø±') document.getElementById('dly_other').classList.add('selected');
        }
        
        function setRoomStatus(status) { 
            document.getElementById('modal-notes').value = status; 
            document.getElementById('st_ready').classList.remove('selected'); 
            document.getElementById('st_maint').classList.remove('selected', 'selected-maint'); 
            if (status === 'Ø¬Ø§Ù‡Ø²Ø©') { 
                document.getElementById('st_ready').classList.add('selected'); 
                document.getElementById('maintenance-fields').style.display = 'none'; 
            } else { 
                document.getElementById('st_maint').classList.add('selected-maint'); 
                document.getElementById('maintenance-fields').style.display = 'block'; 
            } 
        }

        async function confirmFinishRoom() { 
            const room = appState.rooms.find(r => r.id === activeRoomId); 
            if (!room) { showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£: Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.', 'error'); return; }
            
            const status = document.getElementById('modal-notes').value; 
            const isLate = document.getElementById('delay-reason-section').style.display === 'block'; 
            const delayReason = document.getElementById('modal-delay').value; 
            const shouldSendWhatsapp = document.getElementById('inpSendWhatsapp').checked; 
            
            if (isLate && !delayReason) { showAlert('âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù„Ø£Ù†Ù‡ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.', 'warning'); return; } 
            
            room.historyLogs.push({ action: 'ØªÙˆØ«ÙŠÙ‚', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }); 
            
            if (status === 'ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©') { 
                const desc = document.getElementById('repair-details-input').value; 
                const file = document.getElementById('modal-img-camera-input').files[0]; 
                
                if (!desc || !file) { showAlert('âš ï¸ Ù…Ø·Ù„ÙˆØ¨ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'warning'); return; } 
                
                const btn = document.getElementById('btn_confirm_finish');
                btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; 
                btn.disabled = true; 
                
                const imgUrl = await uploadToImgBB(file); 
                if (!imgUrl) { 
                    btn.disabled = false; 
                    btn.innerText = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€'; 
                    showAlert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error'); 
                    return; 
                } 
                
                const maintEntry = { id: room.id, num: room.num, type: room.type, history: room.historyLogs, isLate, delayReason: isLate ? delayReason : '', maintDesc: desc, maintImg: imgUrl, startTime: Date.now() }; 
                appState.activeMaintenance.unshift(maintEntry); 
                appState.rooms = appState.rooms.filter(r => r.id !== room.id); 
                saveData(); 
                closeAllModals(); 
                
                btn.innerText = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€'; 
                btn.disabled = false; 
                
                if (shouldSendWhatsapp) { 
                    const hist = maintEntry.history.map(h => `${h.action}: ${h.time}`).join('\n'); 
                    let waMsg = `*ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ ØµÙŠØ§Ù†Ø© (ØºØ±ÙØ© ${maintEntry.num})* \n----------------\n${hist}\n----------------\nğŸ› ï¸ Ø§Ù„Ø¹Ø·Ù„: ${desc}\nâš ï¸ Ø§Ù„ØªØ£Ø®ÙŠØ±: ${isLate ? delayReason : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}\nğŸ“ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©: ${imgUrl}`; 
                    window.location.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
                } 
            } else { 
                const logEntry = { num: room.num, type: room.type, status: status, history: room.historyLogs, isLate, delayReason: isLate ? delayReason : '' }; 
                appState.log.unshift(logEntry); 
                appState.rooms = appState.rooms.filter(r => r.id !== room.id); 
                saveData(); 
                closeAllModals(); 
                
                if (shouldSendWhatsapp) { 
                    const hist = logEntry.history.map(h => `${h.action}: ${h.time}`).join('\n'); 
                    let waMsg = `*ØªÙ‚Ø±ÙŠØ± ØºØ±ÙØ© ${logEntry.num}*\n----------------\n${hist}\n----------------\nâœ… Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²Ø©`; 
                    if (isLate) waMsg += `\nâš ï¸ ØªØ£Ø®ÙŠØ±: ${delayReason}`; 
                    window.location.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
                } 
            } 
        }

        function openCompleteMaintenanceModal(id) { activeMaintId = id; const maint = appState.activeMaintenance.find(m => m.id === id); if (!maint) return; document.getElementById('maint-room-num-display').innerText = `ØºØ±ÙØ© ${maint.num}`; document.getElementById('maint-img-camera-input').value = ''; document.getElementById('complete-maint-modal').style.display = 'flex'; }
        async function confirmCompleteMaintenance() { const maint = appState.activeMaintenance.find(m => m.id === activeMaintId); if (!maint) return; const file = document.getElementById('maint-img-camera-input').files[0]; if (!file) { showAlert('Ù…Ø·Ù„ÙˆØ¨ ØµÙˆØ±Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error'); return; } document.getElementById('btn_confirm_maint_finish').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; document.getElementById('btn_confirm_maint_finish').disabled = true; const imgUrl = await uploadToImgBB(file); if (!imgUrl) { document.getElementById('btn_confirm_maint_finish').disabled = false; document.getElementById('btn_confirm_maint_finish').innerText = 'ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€'; showAlert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ ImgBB. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error'); return; } maint.timeFinish = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }); maint.finishImg = imgUrl; appState.activeMaintenance = appState.activeMaintenance.filter(m => m.id !== activeMaintId); appState.completedMaintenanceLog.unshift(maint); saveData(); closeAllModals(); document.getElementById('btn_confirm_maint_finish').innerText = 'ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€'; document.getElementById('btn_confirm_maint_finish').disabled = false; const hist = maint.history.map(h => `${h.action}: ${h.time}`).join(' | '); let waMsg = `*âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© (ØºØ±ÙØ© ${maint.num})* \n----------------\nğŸ“ ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØµÙŠØ§Ù†Ø© ÙÙŠ: ${hist}\nğŸ› ï¸ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ù…ÙˆØ«Ù‚: ${maint.maintDesc}\nâ° ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠ: ${maint.timeFinish}\nğŸ“ ØµÙˆØ±Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: ${maint.finishImg}`; window.location.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`; }
        
        function completeRequest(id) { 
            const req = appState.guestRequests.find(r => r.id === id); 
            if (!req) return; 
            const logEntry = { id: Date.now(), num: req.num, type: 'request', status: 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ…', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }), maintDesc: `Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„: ${req.details}`, history: [{ action: 'Ø·Ù„Ø¨', time: req.schedTime }, { action: 'ØªÙ†ÙÙŠØ°', time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }) }] }; 
            
            if(!appState.guestRequestsLog) appState.guestRequestsLog = [];
            appState.guestRequestsLog.unshift(logEntry); 
            
            appState.guestRequests = appState.guestRequests.filter(r => r.id !== id); 
            saveData(); 
            render(); 
            showAlert(`ØªÙ… ØªÙˆØ«ÙŠÙ‚ ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨ Ø§Ù„ØºØ±ÙØ© ${req.num}`, 'success'); 
        }
        
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(modal => modal.style.display = 'none'); }
        function toggleTurboMode() { appState.turbo = !appState.turbo; document.getElementById('turbo-mode-btn').classList.toggle('turbo-active', appState.turbo); saveData(); render(); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function updateSearch() { appState.searchText = document.getElementById('search-bar').value; render(); }
        function showResetModal() { pendingAction = 'archive'; document.getElementById('admin-password').value = ''; document.getElementById('password-modal').style.display = 'flex'; }
        function showLogClearModal() { pendingAction = 'clearLog'; document.getElementById('admin-password').value = ''; document.getElementById('password-modal').style.display = 'flex'; }
        
        function checkPasswordAndAction() { const password = document.getElementById('admin-password').value; if (password === CONFIG.adminPass) { if (pendingAction === 'clearLog') { appState.log = []; appState.completedMaintenanceLog = []; appState.activeMaintenance = []; appState.guestRequests = []; appState.guestRequestsLog = []; saveData(); showAlert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.', 'success'); } else if (pendingAction === 'archive') { const now = new Date(); const archiveKey = `abella_archive_${now.getFullYear()}_${now.getMonth() + 1}_${now.getDate()}`; const archiveData = { log: appState.log, completedMaintenanceLog: appState.completedMaintenanceLog, guestRequests: appState.guestRequests, guestRequestsLog: appState.guestRequestsLog, timestamp: now.toISOString() }; localStorage.setItem(archiveKey, JSON.stringify(archiveData)); appState.log = []; appState.completedMaintenanceLog = []; appState.guestRequests = []; appState.guestRequestsLog = []; saveData(); showAlert('ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­.', 'success'); } closeAllModals(); } else { showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.', 'error'); } }
        
        function toggleTurboInput() { if (currentAddMode === 'request') { document.getElementById('stayOptions').style.display = document.getElementById('inpSuperTurbo').checked ? 'none' : 'block'; } }
        function generateDailyReport() { let msg = `*ØªÙ‚Ø±ÙŠØ± Ù…Ù†Ø¸ÙˆÙ…Ø© Adora Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© - ${new Date().toLocaleDateString('ar-EG')}*%0A--------------------------------%0A`; const allLog = [...appState.log, ...appState.completedMaintenanceLog, ...appState.guestRequestsLog]; allLog.sort((a, b) => b.id - a.id); allLog.forEach(item => { const findTime = (keywords) => { if (!item.history) return '--'; const h = item.history.find(x => keywords.some(k => x.action.includes(k))); if (!h) return '--'; return h.time.replace(/:\d{2}(?=\s|$)/, '').replace(/:\d{2}$/, ''); }; if (item.type === 'request') { msg += `ğŸ”” *ØºØ±ÙØ© ${item.num}* (Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„)%0A   - Ø§Ù„Ø·Ù„Ø¨: ${item.maintDesc.replace('Ø·Ù„Ø¨ Ù†Ø²ÙŠÙ„: ', '')}%0A   - âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° (${item.time.replace(/:\d{2}$/, '')})%0A--------------------------------%0A`; } else { const tEntry = findTime(['Ø¯Ø®ÙˆÙ„']); const tClean = findTime(['Ø¨Ø¯Ø¡']); const tCheck = findTime(['ØªÙ…', 'ØªÙˆØ«ÙŠÙ‚']); msg += `ğŸ”¹ *ØºØ±ÙØ© ${item.num}* (${item.type === 'out' ? 'Ø®Ø±ÙˆØ¬' : 'Ø³Ø§ÙƒÙ†'})%0A   - Ø¯Ø®ÙˆÙ„: ${tEntry} | ØªÙ†Ø¸ÙŠÙ: ${tClean} | ÙØ­Øµ: ${tCheck}%0A`; if (item.finishImg) msg += `   - ğŸ› ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ØµÙŠØ§Ù†Ø© Ù…Ù†Ø¬Ø²Ø© âœ…%0A`; else if (item.maintDesc) msg += `   - ğŸ› ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ØªØ­ØªØ§Ø¬ ØµÙŠØ§Ù†Ø©%0A`; else msg += `   - âœ… Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²Ø©%0A`; if (item.isLate) msg += `   - âš ï¸ ØªØ£Ø®ÙŠØ±: ${item.delayReason}%0A`; if (item.maintDesc) msg += `   - ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${item.maintDesc}%0A`; msg += `--------------------------------%0A`; } }); const totalOut = allLog.filter(x => x.type === 'out').length; const totalStay = allLog.filter(x => x.type === 'stay').length; const activeMaint = appState.activeMaintenance.length; const activeRequests = appState.guestRequests.length; msg += `ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø®Ø±ÙˆØ¬: ${totalOut} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§ÙƒÙ†: ${totalStay}%0A`; if (activeMaint > 0) msg += `ğŸš¨ ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·Ø©: ${activeMaint}%0A`; if (activeRequests > 0) msg += `ğŸ›ï¸ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©: ${activeRequests}%0A`; window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`; }
        
        async function uploadToImgBB(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const scale = 800 / Math.max(img.width, 800); canvas.width = img.width * scale; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob(function(blob) { const formData = new FormData(); formData.append('image', blob); fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.imgbbKey}`, { method: 'POST', body: formData }).then(response => response.json()).then(data => resolve(data.data.url)).catch(() => resolve(null)); }, 'image/jpeg', 0.8); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }
        function setupReelControl(container, textElement, type, stepVal) { let startY = 0; let isAnimating = false; container.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, { passive: false }); container.addEventListener('touchmove', (e) => { e.preventDefault(); if (isAnimating) return; const currentY = e.touches[0].clientY; const diff = startY - currentY; if (Math.abs(diff) > 20) { isAnimating = true; const direction = diff > 0 ? 1 : -1; if (navigator.vibrate) navigator.vibrate(10); playTickSound(); const animClass = direction > 0 ? 'roll-up' : 'roll-down'; textElement.classList.add(animClass); setTimeout(() => { if (type === 'period') { togglePeriod(); } else { changeTimeValue(type, direction * stepVal); } }, 100); setTimeout(() => { textElement.classList.remove(animClass); isAnimating = false; startY = currentY; }, 210); } }, { passive: false }); }
        function playTickSound() { try { const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(500, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.04); gain.gain.setValueAtTime(0.05, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.04); osc.connect(gain); gain.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.05); } catch (e) {} }
        
        // Setup Time Click Listeners Manually since they are complex
        const setupTime = (id, type, step) => { const el = document.getElementById(id); const textEl = document.getElementById(type === 'hour' ? 'inpHour' : type === 'minute' ? 'inpMinute' : 'inpPeriodText'); if (el && textEl) { el.onclick = () => { playTickSound(); if(type === 'period') togglePeriod(); else changeTimeValue(type, step); }; setupReelControl(el, textEl, type, step); } };
        setupTime('hourBox', 'hour', 1); setupTime('minuteBox', 'minute', 5); setupTime('periodBox', 'period', 0);

        // Mock showAlert since it was called but undefined
        function showAlert(msg, type) { alert(msg); }
    </script>
</body>
</html>
